import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Badge } from "@/components/ui/badge";
import { ScrollArea } from "@/components/ui/scroll-area";
import { useTheme } from "@/contexts/ThemeContext";
import { Moon, Sun, FileText, Download, Search, X } from "lucide-react";
import { useState, useMemo } from "react";
import { trpc } from "@/lib/trpc";
import jsPDF from "jspdf";
import { toast } from "sonner";
import { Input } from "@/components/ui/input";
import { CommentDialog } from "@/components/CommentDialog";

interface AffidavitSection {
  title: string;
  paragraphs: Record<string, string>;
  jr_responses?: Record<string, string>;
  dr_responses?: Record<string, string>;
}

interface AffidavitData {
  [key: string]: AffidavitSection;
}

export default function Home() {
  const { theme, toggleTheme } = useTheme();
  const [selectedSection, setSelectedSection] = useState<string>("7");
  const [hoveredParagraph, setHoveredParagraph] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState<string>("");
  
  // Fetch data from database via tRPC
  const { data, isLoading, error } = trpc.affidavit.getData.useQuery();

  // Search functionality - must be before early returns
  const searchResults = useMemo(() => {
    if (!searchQuery.trim() || !data) return null;

    const query = searchQuery.toLowerCase();
    const results: {
      section: string;
      matches: Array<{
        type: 'AD' | 'JR' | 'DR';
        paragraphNum: string;
        content: string;
      }>;
    }[] = [];

    // Search across all sections
    Object.entries(data).forEach(([sectionNum, sectionData]) => {
      const matches: Array<{
        type: 'AD' | 'JR' | 'DR';
        paragraphNum: string;
        content: string;
      }> = [];

      // Search AD paragraphs
      Object.entries(sectionData.paragraphs || {}).forEach(([paraNum, content]) => {
        const contentStr = String(content);
        if (paraNum.toLowerCase().includes(query) || contentStr.toLowerCase().includes(query)) {
          matches.push({ type: 'AD', paragraphNum: paraNum, content: contentStr });
        }
      });

      // Search JR responses
      Object.entries(sectionData.jr_responses || {}).forEach(([paraNum, content]) => {
        const contentStr = String(content);
        if (paraNum.toLowerCase().includes(query) || contentStr.toLowerCase().includes(query)) {
          matches.push({ type: 'JR', paragraphNum: paraNum, content: contentStr });
        }
      });

      // Search DR responses
      Object.entries(sectionData.dr_responses || {}).forEach(([paraNum, content]) => {
        const contentStr = String(content);
        if (paraNum.toLowerCase().includes(query) || contentStr.toLowerCase().includes(query)) {
          matches.push({ type: 'DR', paragraphNum: paraNum, content: contentStr });
        }
      });

      if (matches.length > 0) {
        results.push({ section: sectionNum, matches });
      }
    });

    return results;
  }, [searchQuery, data]);

  // Highlight search terms in text
  const highlightText = (text: string, query: string) => {
    if (!query.trim()) return text;
    const parts = text.split(new RegExp(`(${query})`, 'gi'));
    return parts.map((part, i) => 
      part.toLowerCase() === query.toLowerCase() ? 
        <mark key={i} className="bg-yellow-300 dark:bg-yellow-600">{part}</mark> : 
        part
    );
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <FileText className="w-16 h-16 mx-auto mb-4 animate-pulse" />
          <p className="text-lg">Loading affidavit data from database...</p>
        </div>
      </div>
    );
  }

  if (error || !data) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <FileText className="w-16 h-16 mx-auto mb-4 text-destructive" />
          <p className="text-lg text-destructive">Failed to load affidavit data</p>
          <p className="text-sm text-muted-foreground mt-2">{error?.message || "Unknown error"}</p>
        </div>
      </div>
    );
  }

  const section = data[selectedSection];
  const adParagraphs = Object.keys(section?.paragraphs || {}).sort((a, b) => {
    const aParts = a.split('.').map(Number);
    const bParts = b.split('.').map(Number);
    for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
      if ((aParts[i] || 0) !== (bParts[i] || 0)) {
        return (aParts[i] || 0) - (bParts[i] || 0);
      }
    }
    return 0;
  });

  // Helper function to check if a paragraph should be highlighted
  const isHighlighted = (paragraphNum: string) => {
    if (!hoveredParagraph) return false;
    // Extract base number (e.g., "7.1" from "7.1.1")
    const hoveredBase = hoveredParagraph.split('.').slice(0, 2).join('.');
    const currentBase = paragraphNum.split('.').slice(0, 2).join('.');
    return hoveredBase === currentBase;
  };

  // PDF export function
  const exportToPDF = () => {
    try {
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 15;
      const columnWidth = (pageWidth - 4 * margin) / 3;
      let yPosition = margin;

      // Title
      pdf.setFontSize(16);
      pdf.setFont('helvetica', 'bold');
      pdf.text(`Section ${selectedSection}: ${section.title}`, margin, yPosition);
      yPosition += 10;

      // Column headers
      pdf.setFontSize(10);
      pdf.setFont('helvetica', 'bold');
      pdf.text("Peter's AD Paragraphs", margin, yPosition);
      pdf.text("Jacqueline's JR Responses", margin + columnWidth + margin, yPosition);
      pdf.text("Daniel's DR Responses", margin + 2 * (columnWidth + margin), yPosition);
      yPosition += 8;

      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(8);

      // Process each AD paragraph
      for (const adNum of adParagraphs) {
        // Check if we need a new page
        if (yPosition > pageHeight - margin - 20) {
          pdf.addPage();
          yPosition = margin;
        }

        // AD paragraph
        const adText = section.paragraphs[adNum];
        const adLines = pdf.splitTextToSize(`AD ${adNum}: ${adText}`, columnWidth);
        
        // Find matching JR responses
        const jrNums = Object.keys(section.jr_responses || {}).filter(jrNum => {
          const jrBase = jrNum.split('.').slice(0, 2).join('.');
          const adBase = adNum.split('.').slice(0, 2).join('.');
          return jrBase === adBase;
        }).sort();

        // Find matching DR responses
        const drNums = Object.keys(section.dr_responses || {}).filter(drNum => {
          const drBase = drNum.split('.').slice(0, 2).join('.');
          const adBase = adNum.split('.').slice(0, 2).join('.');
          return drBase === adBase;
        }).sort();

        // Calculate max height needed
        let jrLines: string[] = [];
        for (const jrNum of jrNums) {
          const jrText = section.jr_responses?.[jrNum] || '';
          jrLines = jrLines.concat(pdf.splitTextToSize(`JR ${jrNum}: ${jrText}`, columnWidth));
        }

        let drLines: string[] = [];
        for (const drNum of drNums) {
          const drText = section.dr_responses?.[drNum] || '';
          drLines = drLines.concat(pdf.splitTextToSize(`DR ${drNum}: ${drText}`, columnWidth));
        }

        const maxLines = Math.max(adLines.length, jrLines.length, drLines.length);
        const blockHeight = maxLines * 4 + 5;

        // Check if block fits on page
        if (yPosition + blockHeight > pageHeight - margin) {
          pdf.addPage();
          yPosition = margin;
        }

        const startY = yPosition;

        // Draw AD column
        pdf.text(adLines, margin, yPosition);

        // Draw JR column
        pdf.text(jrLines, margin + columnWidth + margin, startY);

        // Draw DR column
        pdf.text(drLines, margin + 2 * (columnWidth + margin), startY);

        yPosition += blockHeight;

        // Draw separator line
        pdf.setDrawColor(200, 200, 200);
        pdf.line(margin, yPosition, pageWidth - margin, yPosition);
        yPosition += 3;
      }

      // Save PDF
      pdf.save(`affidavit-comparison-section-${selectedSection}.pdf`);
      toast.success('PDF exported successfully!');
    } catch (error) {
      console.error('PDF export error:', error);
      toast.error('Failed to export PDF');
    }
  };

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="border-b sticky top-0 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 z-50">
        <div className="container flex items-center justify-between h-16">
          <div className="flex items-center gap-3">
            <FileText className="w-6 h-6" />
            <div>
              <h1 className="text-lg font-semibold">Affidavit Comparison</h1>
              <p className="text-xs text-muted-foreground">AD Paragraphs 7-11 vs JR/DR Responses</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground" />
              <Input
                type="text"
                placeholder="Search paragraphs or keywords..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-9 pr-9 w-64"
              />
              {searchQuery && (
                <Button
                  variant="ghost"
                  size="icon"
                  className="absolute right-0 top-1/2 transform -translate-y-1/2 h-full"
                  onClick={() => setSearchQuery("")}
                >
                  <X className="w-4 h-4" />
                </Button>
              )}
            </div>
            <Button variant="outline" size="sm" onClick={exportToPDF}>
              <Download className="w-4 h-4 mr-2" />
              Export PDF
            </Button>
            <Button variant="ghost" size="icon" onClick={toggleTheme}>
              {theme === "dark" ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
            </Button>
          </div>
        </div>
      </header>

      {/* Search Results */}
      {searchResults && searchResults.length > 0 && (
        <div className="border-b bg-muted/50">
          <div className="container py-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-sm font-semibold">
                Found {searchResults.reduce((acc, r) => acc + r.matches.length, 0)} results across {searchResults.length} sections
              </h3>
              <Button variant="ghost" size="sm" onClick={() => setSearchQuery("")}>
                Clear search
              </Button>
            </div>
            <ScrollArea className="h-64">
              <div className="space-y-4">
                {searchResults.map((result) => (
                  <div key={result.section} className="space-y-2">
                    <div className="flex items-center gap-2">
                      <Badge variant="secondary">Section {result.section}</Badge>
                      <span className="text-xs text-muted-foreground">{result.matches.length} matches</span>
                    </div>
                    <div className="space-y-2 pl-4">
                      {result.matches.map((match, idx) => (
                        <div
                          key={idx}
                          className="text-sm p-2 rounded-md bg-background hover:bg-accent cursor-pointer transition-colors"
                          onClick={() => {
                            setSelectedSection(result.section);
                            setSearchQuery("");
                          }}
                        >
                          <div className="flex items-center gap-2 mb-1">
                            <Badge variant="outline" className="text-xs">
                              {match.type} {match.paragraphNum}
                            </Badge>
                          </div>
                          <p className="text-xs text-muted-foreground line-clamp-2">
                            {highlightText(match.content, searchQuery)}
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </ScrollArea>
          </div>
        </div>
      )}

      {searchResults && searchResults.length === 0 && searchQuery && (
        <div className="border-b bg-muted/50">
          <div className="container py-4 text-center text-sm text-muted-foreground">
            No results found for "{searchQuery}"
          </div>
        </div>
      )}

      {/* Main Content */}
      <main className="container py-6">
        {/* Section Tabs */}
        <Tabs value={selectedSection} onValueChange={setSelectedSection} className="mb-6">
          <TabsList className="grid w-full grid-cols-5">
            {Object.keys(data).map((sectionNum) => (
              <TabsTrigger key={sectionNum} value={sectionNum}>
                Section {sectionNum}
              </TabsTrigger>
            ))}
          </TabsList>
        </Tabs>

        {/* Section Title */}
        <div className="mb-6">
          <h2 className="text-2xl font-bold mb-2">Section {selectedSection}: {section?.title}</h2>
          <div className="flex gap-2">
            <Badge variant="outline">{adParagraphs.length} AD Paragraphs</Badge>
            <Badge variant="outline">{Object.keys(section?.jr_responses || {}).length} JR Responses</Badge>
            <Badge variant="outline">{Object.keys(section?.dr_responses || {}).length} DR Responses</Badge>
          </div>
        </div>

        {/* Three-Column Comparison */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          {/* AD Column */}
          <Card className="lg:sticky lg:top-20 lg:h-[calc(100vh-8rem)]">
            <CardHeader className="pb-3">
              <CardTitle className="text-base">Peter's AD Paragraphs</CardTitle>
            </CardHeader>
            <CardContent className="p-0">
              <ScrollArea className="h-[calc(100vh-14rem)] lg:h-[calc(100vh-12rem)]">
                <div className="space-y-4 p-6 pt-0">
                  {adParagraphs.map((adNum) => (
                    <div 
                      key={adNum} 
                      id={`ad-${adNum}`} 
                      className={`group scroll-mt-20 transition-all duration-200 rounded-lg p-3 -mx-3 ${
                        isHighlighted(adNum) 
                          ? 'bg-primary/10 ring-2 ring-primary/20' 
                          : 'hover:bg-muted/50'
                      }`}
                      onMouseEnter={() => setHoveredParagraph(adNum)}
                      onMouseLeave={() => setHoveredParagraph(null)}
                    >
                      <div className="flex items-start gap-2 mb-2">
                        <Badge className="shrink-0">AD {adNum}</Badge>
                        <CommentDialog 
                          sectionNumber={selectedSection} 
                          paragraphNumber={adNum} 
                          paragraphType="AD" 
                        />
                      </div>
                      <p className="text-sm leading-relaxed">{section.paragraphs[adNum]}</p>
                    </div>
                  ))}
                </div>
              </ScrollArea>
            </CardContent>
          </Card>

          {/* JR Column */}
          <Card className="lg:sticky lg:top-20 lg:h-[calc(100vh-8rem)]">
            <CardHeader className="pb-3">
              <CardTitle className="text-base">Jacqueline's JR Responses</CardTitle>
            </CardHeader>
            <CardContent className="p-0">
              <ScrollArea className="h-[calc(100vh-14rem)] lg:h-[calc(100vh-12rem)]">
                <div className="space-y-4 p-6 pt-0">
                  {Object.keys(section?.jr_responses || {})
                    .sort((a, b) => {
                      const aParts = a.split('.').map(Number);
                      const bParts = b.split('.').map(Number);
                      for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
                        if ((aParts[i] || 0) !== (bParts[i] || 0)) {
                          return (aParts[i] || 0) - (bParts[i] || 0);
                        }
                      }
                      return 0;
                    })
                    .map((jrNum) => (
                      <div 
                        key={jrNum} 
                        id={`jr-${jrNum}`} 
                        className={`group scroll-mt-20 transition-all duration-200 rounded-lg p-3 -mx-3 ${
                          isHighlighted(jrNum) 
                            ? 'bg-secondary/20 ring-2 ring-secondary/30' 
                            : 'hover:bg-muted/50'
                        }`}
                        onMouseEnter={() => setHoveredParagraph(jrNum)}
                        onMouseLeave={() => setHoveredParagraph(null)}
                      >
                        <div className="flex items-start gap-2 mb-2">
                          <Badge variant="secondary" className="shrink-0">JR {jrNum}</Badge>
                          <CommentDialog 
                            sectionNumber={selectedSection} 
                            paragraphNumber={jrNum} 
                            paragraphType="JR" 
                          />
                        </div>
                        <p className="text-sm leading-relaxed">{section.jr_responses?.[jrNum]}</p>
                      </div>
                    ))}
                </div>
              </ScrollArea>
            </CardContent>
          </Card>

          {/* DR Column */}
          <Card className="lg:sticky lg:top-20 lg:h-[calc(100vh-8rem)]">
            <CardHeader className="pb-3">
              <CardTitle className="text-base">Daniel's DR Responses</CardTitle>
            </CardHeader>
            <CardContent className="p-0">
              <ScrollArea className="h-[calc(100vh-14rem)] lg:h-[calc(100vh-12rem)]">
                <div className="space-y-4 p-6 pt-0">
                  {Object.keys(section?.dr_responses || {})
                    .sort((a, b) => {
                      const aParts = a.split('.').map(Number);
                      const bParts = b.split('.').map(Number);
                      for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
                        if ((aParts[i] || 0) !== (bParts[i] || 0)) {
                          return (aParts[i] || 0) - (bParts[i] || 0);
                        }
                      }
                      return 0;
                    })
                    .map((drNum) => (
                      <div 
                        key={drNum} 
                        id={`dr-${drNum}`} 
                        className={`group scroll-mt-20 transition-all duration-200 rounded-lg p-3 -mx-3 ${
                          isHighlighted(drNum) 
                            ? 'bg-secondary/20 ring-2 ring-secondary/30' 
                            : 'hover:bg-muted/50'
                        }`}
                        onMouseEnter={() => setHoveredParagraph(drNum)}
                        onMouseLeave={() => setHoveredParagraph(null)}
                      >
                        <div className="flex items-start gap-2 mb-2">
                          <Badge variant="secondary" className="shrink-0">DR {drNum}</Badge>
                          <CommentDialog 
                            sectionNumber={selectedSection} 
                            paragraphNumber={drNum} 
                            paragraphType="DR" 
                          />
                        </div>
                        <p className="text-sm leading-relaxed">{section.dr_responses?.[drNum]}</p>
                      </div>
                    ))}
                </div>
              </ScrollArea>
            </CardContent>
          </Card>
        </div>
      </main>
    </div>
  );
}
